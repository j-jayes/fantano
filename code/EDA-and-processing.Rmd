---
title: "Cleaning and data processing/ feature engineering"
author: "JJayes"
date: "29/06/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
# library(reticulate)
```



Getting subtitles using python

```{r}
# version <- "3.7.4"
# # install_python(version = version)
# virtualenv_create("my-environment", python_version = version)
# use_virtualenv("my-environment", required = TRUE)
# 
# # installing the package needed for getting the transcripts
# virtualenv_install("my-environment", "youtube_transcript_api")

```

Things to get from video description.

Could maybe do these in a recipe so that I can deploy it via Github Actions and do a CI thing. Would be a fun way to learn recipes. Maybe not the most stable though and relies on the fact that he will continue to structure his descriptions in such a way that I can extract the information methodologically. 

- score
- statistics (views, comments, etc.)
- date
- genre
- record company
- duration

```{r}
tbl <- read_rds("data/album_reviews_raw.rds")

tbl %>% skimr::skim()

```



### EDA

```{r}
tbl <- tbl %>% 
    # the \n before it is to correct for the song called 10/10 by Rex Orange County
    mutate(score_raw = str_extract(snippet.description, "\n[0-9]/10|\n10/10|CLASSIC"),
           score = parse_number(score_raw)) 

tbl %>% 
    count(score_raw, sort = T)

tbl %>% 
    select(score, score_raw) %>% 
    arrange(desc(score))

tbl %>% 
    select(score, score_raw, snippet.description) %>% 
    arrange((score))

tbl %>% 
    ggplot(aes(score)) +
    geom_histogram()

tbl %>% filter(score == 10) %>% pull(snippet.description)

tbl %>% 
    filter(snippet.title == "Rex Orange County - Pony ALBUM REVIEW") %>% 
    select(snippet.description) %>% view()

```

Statistics

```{r}
tbl <- tbl %>% 
    mutate(across(starts_with("statistics"), as.numeric))

tbl %>% 
    ggplot(aes(statistics.viewCount)) +
    geom_density()

```

Date

```{r}
tbl <- tbl %>% 
    mutate(published_date = lubridate::date(snippet.publishedAt))

tbl %>% 
    ggplot(aes(published_date, score)) +
    geom_jitter() +
    geom_smooth(method = "lm")

tbl %>% 
    ggplot(aes(published_date, statistics.viewCount)) +
    geom_point() +
    geom_smooth() +
    scale_y_log10(labels = scales::number_format())

tbl %>% 
    ggplot(aes(published_date, statistics.commentCount)) +
    geom_point() +
    geom_smooth() +
    scale_y_log10(labels = scales::number_format())

```

Duration

```{r}
tbl <- tbl %>%
    mutate(duration = lubridate::duration(contentDetails.duration)) 

tbl %>% 
    ggplot(aes(published_date, duration)) +
    geom_point() +
    geom_smooth()

tbl %>% 
    arrange(desc(duration)) %>% head() %>% view()

```

Tags

```{r}
tbl %>% 
    select(snippet.tags) %>% 
    mutate(tags = paste(unlist(snippet.tags), collapse = ";"))

review_list <- tbl %>%
    filter(contentDetails.caption == "true") %>% 
    select(video_id)

review_list %>% write.csv(., file = "data/video_ids.csv", row.names = F)

```

